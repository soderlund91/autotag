<div id="AutoTagConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
     data-require="emby-input,emby-button,emby-checkbox,emby-textarea"
     data-controller="__plugin/AutoTagJS">

    <style>
        .tag-row {
            background: var(--theme-background-level2);
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-left: 5px solid #52B54B;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .tag-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            color: var(--theme-text-primary);
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

            .tag-header:hover {
                background: var(--theme-background-level3);
            }

        .tag-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .tag-title {
            font-size: 1.1em;
            font-weight: bold;
            margin: 0 15px;
            color: var(--theme-text-primary);
        }

        .tag-status {
            font-size: 0.8em;
            color: var(--theme-text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tag-body {
            padding: 20px;
            display: none;
            border-top: 1px solid var(--line-color);
            color: var(--theme-text-primary);
            background: var(--theme-background-level1);
        }

        .url-list-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .url-row {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .advanced-section {
            background: var(--theme-background-level2);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 5px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .advanced-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            color: var(--theme-text-primary);
        }

            .advanced-header:hover {
                background: rgba(255, 255, 255, 0.05);
            }

        .advanced-body {
            padding: 20px;
            display: none;
            border-top: 1px solid var(--line-color);
            color: var(--theme-text-primary);
            background: var(--theme-background-level1);
        }

        .floating-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9000;
            display: flex;
            gap: 15px;
        }

        .fab-btn {
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            height: 45px !important;
            border-radius: 25px !important;
            padding: 0 20px !important;
            white-space: nowrap;
        }

        .btn-save {
            background-color: #52B54B !important;
            color: #fff !important;
        }

        .btn-run {
            background-color: #00a4dc !important;
            color: #fff !important;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            background-color: #52B54B;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

            .status-dot.running {
                background-color: #00a4dc;
                animation: pulse 1.5s infinite;
            }

            .status-dot.failed {
                background-color: #cc3333;
            }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 0.7;
            }

            70% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(0.95);
                opacity: 0.7;
            }
        }

        .btn-log-trigger, .btn-help-trigger {
            background: rgba(255,255,255,0.08) !important;
            color: var(--theme-text-primary) !important;
            padding: 0 12px !important;
            height: 32px !important;
            border-radius: 16px !important;
            margin-left: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85em !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            transition: all 0.2s;
        }

            .btn-log-trigger:hover {
                border-color: #00a4dc !important;
            }

            .btn-help-trigger:hover {
                border-color: #52B54B !important;
            }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 99999;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background-color: #1e1e1e !important;
            color: #eeeeee !important;
            padding: 0;
            border-radius: 12px;
            max-width: 650px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.15);
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            overflow: hidden;
        }

        .modal-visible .modal-content {
            transform: translateY(0);
        }

        .modal-header-bar {
            background: linear-gradient(135deg, #52B54B 0%, #3a8c34 100%);
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #fff;
            border-bottom: 1px solid rgba(0,0,0,0.2);
        }

        .modal-header-icon {
            font-size: 2.2em !important;
        }

        .modal-header-title {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .modal-body-scroll {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .help-step {
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
        }

        .step-num {
            background: #2a2a2a;
            color: #fff;
            border: 2px solid #52B54B;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .step-text {
            color: #dddddd;
            font-size: 1em;
            line-height: 1.6;
        }

        .help-link {
            color: #52B54B;
            text-decoration: none;
            font-weight: bold;
        }

            .help-link:hover {
                color: #6ee066;
                border-bottom: 1px solid #6ee066;
            }

        .info-box {
            margin-top: 8px;
            padding: 12px;
            background: #252525;
            border-radius: 6px;
            font-size: 0.9em;
            border: 1px solid #333;
        }

        .inspiration-container {
            text-align: center;
            margin: 20px 0 30px 0;
            border-bottom: 1px solid var(--line-color);
            padding-bottom: 20px;
        }

        .links-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-top: 10px;
        }

        .simple-link {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--theme-text-secondary) !important;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            opacity: 0.8;
        }

            .simple-link:hover {
                color: var(--theme-text-primary) !important;
                opacity: 1;
                transform: scale(1.05);
            }

            .simple-link img {
                height: 20px;
                width: auto;
                vertical-align: middle;
            }

        .date-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.02);
            padding: 8px;
            border-radius: 4px;
        }

        .tag-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tag-tab {
            padding: 8px 0;
            cursor: pointer;
            opacity: 0.6;
            font-weight: bold;
            border-bottom: 2px solid transparent;
        }

            .tag-tab.active {
                opacity: 1;
                border-bottom-color: #52B54B;
            }
    </style>

    <div class="content-primary">
        <div class="verticalSection">
            <div style="display:flex; align-items:center; margin-bottom: 10px; gap: 10px;">
                <h2 class="sectionTitle" style="margin:0;">Settings</h2>

                <button type="button" is="emby-button" class="btn-help-trigger" id="btnOpenHelp" title="Open Setup Guide">
                    <i class="md-icon">help</i>
                    <span>Help</span>
                </button>

                <button type="button" is="emby-button" class="btn-log-trigger" id="btnOpenLogs" title="View Logs">
                    <i class="md-icon">terminal</i>
                    <span>Logs</span>
                </button>

                <div id="lastRunIndicator" style="display: flex; align-items: center; margin-left: 10px; padding-left: 15px; border-left: 1px solid rgba(255,255,255,0.1);">
                    <span style="font-size: 0.85em; opacity: 0.5; margin-right: 8px;">Last run:</span>
                    <span class="status-dot" id="dotStatus"></span>
                    <span id="lastRunStatusLabel" style="font-size: 0.85em; opacity: 0.8;">Idle</span>
                </div>
            </div>

            <p class="textMuted">Configure API keys and sources for automatic tagging.</p>

            <form class="AutoTagForm">
                <div class="inputContainer">
                    <input is="emby-input" type="text" id="txtTraktClientId" label="Trakt Client ID" />
                    <div class="fieldDescription">
                        Create app at <a href="https://trakt.tv/oauth/applications" target="_blank" class="help-link">Trakt.tv</a>.
                    </div>
                </div>

                <div class="inputContainer">
                    <input is="emby-input" type="text" id="txtMdblistApiKey" label="MDBList API Key" />
                    <div class="fieldDescription">
                        Get key at <a href="https://mdblist.com/preferences/" target="_blank" class="help-link">MDBList Preferences</a>.
                    </div>
                </div>

                <div class="advanced-section" id="advancedSettings">
                    <div class="advanced-header">
                        <i class="md-icon expand-icon">expand_more</i>
                        <span style="margin-left: 10px; font-weight: bold;">Advanced Settings</span>
                    </div>
                    <div class="advanced-body" style="display: none;">
                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkExtendedConsoleOutput" />
                                <span>Extended Log Output</span>
                            </label>
                            <div class="fieldDescription">Enable verbose logging for debugging purposes.</div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top: 15px;">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkDryRunMode" />
                                <span>Dry Run Mode</span>
                            </label>
                            <div class="fieldDescription">Simulate process without modifying database.</div>
                        </div>
                    </div>
                </div>

                <div class="advanced-section" id="backupSettings">
                    <div class="advanced-header">
                        <i class="md-icon expand-icon">expand_more</i>
                        <span style="margin-left: 10px; font-weight: bold;">Backup & Restore</span>
                    </div>
                    <div class="advanced-body" style="display: none;">
                        <p class="textMuted" style="font-size:0.9em; margin-bottom:15px;">Export your configuration to a JSON file or restore from a backup.</p>
                        <div style="display:flex; gap:10px;">
                            <button is="emby-button" type="button" id="btnBackupConfig" class="raised" style="background:#222; border:1px solid #444;">
                                <i class="md-icon" style="margin-right:5px;">download</i>Download Backup
                            </button>
                            <button is="emby-button" type="button" id="btnRestoreConfigTrigger" class="raised" style="background:#222; border:1px solid #444;">
                                <i class="md-icon" style="margin-right:5px;">upload</i>Restore Backup
                            </button>
                            <input type="file" id="fileRestoreConfig" accept=".json" style="display:none;" />
                        </div>
                    </div>
                </div>

                <hr style="border-color: var(--line-color);" />

                <div class="inspiration-container">
                    <p class="textMuted" style="margin-bottom: 10px; font-size: 0.9em;">Looking for lists?</p>
                    <div class="links-wrapper">
                        <a href="https://trakt.tv/discover" target="_blank" class="simple-link">
                            <img src="https://i.ibb.co/xSMnN8NK/trakt-logo.png" alt="Trakt" /><span>Trakt</span>
                        </a>
                        <span style="color: var(--theme-text-secondary);">|</span>
                        <a href="https://mdblist.com/toplists/" target="_blank" class="simple-link">
                            <img src="https://i.ibb.co/7JWQDLLR/mdblist.png" alt="MDBList" /><span>MDBList</span>
                        </a>
                    </div>
                </div>

                <div class="sectionTitleContainer flex align-items-center" style="margin-bottom: 1em; margin-top: 2em;">
                    <h2 class="sectionTitle" style="margin-bottom:0;">Tag Sources</h2>
                    <button is="emby-button" type="button" id="btnAddTag" class="raised button-submit mb025" style="margin-left: auto;">
                        <span>+ Add New Source</span>
                    </button>
                </div>

                <div id="tagListContainer" class="verticalSection"></div>

                <br /><br /><br /><br /><br />

                <div class="floating-actions">
                    <button is="emby-button" type="submit" class="raised button-submit fab-btn btn-save">
                        <i class="md-icon" style="margin-right:5px;">save</i><span>Save Settings</span>
                    </button>
                    <button is="emby-button" type="button" id="btnRunSync" class="raised button-submit fab-btn btn-run">
                        <i class="md-icon" style="margin-right:5px;">play_arrow</i><span>Run Full Sync</span>
                    </button>
                </div>
            </form>
        </div>

        <div style="margin-top: 5em; padding-top: 2em; border-top: 1px solid var(--line-color); text-align: center; color: var(--theme-text-secondary);">
            <p style="margin-bottom: 5px; font-weight: bold;">AutoTag v2.1.0.0</p>
            <div style="display: flex; justify-content: center; margin-bottom: 15px;">
                <a href="https://github.com/soderlund91/AutoTag/tree/main" target="_blank" class="simple-link">
                    <i class="md-icon" style="font-size:1.2em;">link</i>
                    <span>GitHub Repository</span>
                </a>
            </div>
            <p style="font-size: 0.75em; opacity: 0.6; font-style: italic;">AutoTag is not affiliated with Trakt.tv or MDBList.</p>
        </div>
    </div>

    <div id="logModalOverlay" class="modal-backdrop">
        <div class="modal-content" style="max-width: 850px; width: 95%;">
            <div class="modal-header-bar" style="background: #222;">
                <i class="md-icon modal-header-icon" style="color: #00a4dc;">terminal</i>
                <div>
                    <h2 class="modal-header-title">Live Execution Log</h2>
                    <span style="opacity:0.7; font-size:0.85em;">Showing latest activity from the server</span>
                </div>
            </div>
            <div class="modal-body-scroll" style="background: #0a0a0a; color: #ececec; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85em; white-space: pre-wrap; padding: 20px; border-top: 1px solid #333;" id="logContent">
            </div>
            <div style="text-align:right; padding: 15px; background: #1a1a1a; border-top: 1px solid #333;">
                <button is="emby-button" type="button" id="btnCloseLogs" class="raised" style="background: #444;">Close</button>
            </div>
        </div>
    </div>

    <div id="helpModalOverlay" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header-bar">
                <i class="md-icon modal-header-icon">school</i>
                <div>
                    <h2 class="modal-header-title">Quick Start Guide</h2>
                    <span style="opacity:0.9; font-size:0.9em;">Get up and running in 4 steps</span>
                </div>
            </div>
            <div class="modal-body-scroll">
                <div class="help-step">
                    <div class="step-num">1</div>
                    <div class="step-text">
                        <strong>Get API Keys</strong>
                        <div class="info-box">
                            <div style="margin-bottom:10px;">
                                <strong>Trakt:</strong> Go to <a href="https://trakt.tv/oauth/applications" target="_blank" class="help-link">My Apps</a>. New App -> Name it "AutoTag".<br>
                                ⚠️ <strong>Redirect URI:</strong> Set to anything, example <code>http://localhost</code>.
                            </div>
                            <div style="border-top:1px dashed #444; padding-top:10px;">
                                <strong>MDBList:</strong> Go to <a href="https://mdblist.com/preferences/" target="_blank" class="help-link">Preferences</a>. Scroll down to "API Access".
                            </div>
                        </div>
                    </div>
                </div>
                <div class="help-step"><div class="step-num">2</div><div class="step-text"><strong>Add a Rule</strong><br>Click the <strong>"+ Add New Source"</strong> button.</div></div>
                <div class="help-step"><div class="step-num">3</div><div class="step-text"><strong>Configure</strong><br />• <strong>Tag Name:</strong> The tag (e.g., "Trending").<br />• <strong>URL:</strong> Link from Trakt/MDBList.<br />• <strong>Schedule:</strong> Set active times for the tag/collection<br />• <strong>Collection:</strong> Create a collection from the list items.<br />• <strong>Advanced settings:</strong> Here you can blacklist specific movies/shows.</div></div>
                <div class="help-step"><div class="step-num">4</div><div class="step-text"><strong>Save & Sync</strong><br>Click <strong>"Save Settings"</strong> then <strong>"Run Full Sync"</strong>.</div></div>
                <div class="help-step"><div class="step-num">5</div><div class="step-text"><strong>Schedule</strong><br>Edit the scheduled run in Embys "Scheduled Tasks".</div></div>
                <div style="text-align:right; margin-top:20px;"><button is="emby-button" type="button" id="btnCloseHelp" class="raised button-submit" style="background:#52B54B; color:white; padding: 0 25px;">Close Guide</button></div>
            </div>
        </div>
    </div>
</div>